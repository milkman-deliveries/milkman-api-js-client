"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib");require("isomorphic-fetch");const t={Accept:"application/json","Content-Type":"application/json"};class s{constructor(e={}){this.baseUrl=e.baseUrl||"/",this.enhancers=e.enhancers||[]}composeUrl(e){let t=this.baseUrl.replace(/\/*$/,"");return t+="/"+e.replace(/^\/*/,""),t}composeRequest(s,r={}){const{headers:i}=r,o=e.__rest(r,["headers"]),n=Object.assign({method:s,headers:Object.assign(Object.assign({},t),i)},o);return this.enhancers.reduce((e,t)=>t(e),n)}fetch(e,t,s){return fetch(this.composeUrl(t),this.composeRequest(e,s))}get(e,t){return this.fetch("GET",e,t)}post(e,t,s){return this.fetch("POST",e,Object.assign({body:JSON.stringify(t)},s))}put(e,t,s){return this.fetch("PUT",e,Object.assign({body:JSON.stringify(t)},s))}patch(e,t,s){return this.fetch("PATCH",e,Object.assign({body:JSON.stringify(t)},s))}delete(e,t){return this.fetch("DELETE",e,t)}}const r=e=>sessionStorage.setItem("MILMAN_COGNITO_ID_TOKEN",e),i=e=>sessionStorage.setItem("MILMAN_SESSION_TOKEN_KEY",e),o=e=>(e.headers||(e.headers={}),e.headers.Authorization="Bearer "+sessionStorage.getItem("MILMAN_COGNITO_ID_TOKEN"),e);var n,h,u;exports.AuthenticationMethod=void 0,(n=exports.AuthenticationMethod||(exports.AuthenticationMethod={})).USER_PASSWORD="USER_PASSWORD_AUTH",n.REFRESH_TOKEN="REFRESH_TOKEN_AUTH";exports.ApiQueryRuleType=void 0,(h=exports.ApiQueryRuleType||(exports.ApiQueryRuleType={})).EQ="$eq",h.NE="$ne",h.GT="$gt",h.GTE="$gte",h.LT="$le",h.LTE="$lte",h.IN="$in";exports.ApiSortValue=void 0,(u=exports.ApiSortValue||(exports.ApiSortValue={}))[u.ASC=1]="ASC",u[u.DESC=0]="DESC";const a=(e,t)=>e[t];exports.ApiAuth=class{constructor(e){this.application=e.application,this.clientId=e.clientId,this.automaticRefresh=e.automaticRefresh||!1,this.refreshTimeoutMs=e.refreshTimeoutMs||33e5,this.useMilkmanSession=e.useMilkmanSession||!1,this.milkmanBaseUrl=e.milkmanBaseUrl||"/"}get authUrl(){return`https://auth.milkmantechnologies.com/${this.application}/login`}_cognitoLogin(e,t){return fetch(this.authUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:exports.AuthenticationMethod.USER_PASSWORD,AuthParameters:{USERNAME:e,PASSWORD:t}})})}_cognitoRefresh(){return fetch(this.authUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:exports.AuthenticationMethod.REFRESH_TOKEN,AuthParameters:{REFRESH_TOKEN:sessionStorage.getItem("MILMAN_COGNITO_REFRESH_TOKEN")}})})}_resolveUser(){return new s({baseUrl:this.milkmanBaseUrl,enhancers:[o]}).get("/milkman/resolveUser?loginSource=Web&rememberMe=true")}scheduleAutomaticRefresh(){this.sessionTimeout&&clearTimeout(this.sessionTimeout),this.sessionTimeout=setTimeout(()=>{this.refresh()},this.refreshTimeoutMs)}login(t,s){return e.__awaiter(this,void 0,void 0,(function*(){const{AuthenticationResult:e,error:o}=yield this._cognitoLogin(t,s).then(e=>e.json());if(o||!e)return Promise.reject(o);const{IdToken:n,RefreshToken:h}=e;var u;if(r(n),u=h,sessionStorage.setItem("MILMAN_COGNITO_REFRESH_TOKEN",u),this.useMilkmanSession){const{session:e}=yield this._resolveUser().then(e=>e.json());i(e)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}refresh(){return e.__awaiter(this,void 0,void 0,(function*(){const{AuthenticationResult:e,error:t}=yield this._cognitoRefresh().then(e=>e.json());if(t||!e)return Promise.reject(t);const{IdToken:s}=e;if(r(s),this.useMilkmanSession){const{session:e}=yield this._resolveUser().then(e=>e.json());i(e)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}},exports.ApiClient=s,exports.ApiQuery=class{constructor(){this.query={}}addRule(e,t,s=""){return this.query.hasOwnProperty(e)||(this.query[e]={}),this.query[e][t]=s,this}removeRule(e,t){return this.query.hasOwnProperty(e)&&this.query[e].hasOwnProperty(t)&&(delete this.query[e][t],0===Object.keys(this.query[e]).length&&delete this.query[e]),this}eq(e,t){return this.addRule(e,exports.ApiQueryRuleType.EQ,t)}ne(e,t){return this.addRule(e,exports.ApiQueryRuleType.NE,t)}gt(e,t){return this.addRule(e,exports.ApiQueryRuleType.GT,t)}gte(e,t){return this.addRule(e,exports.ApiQueryRuleType.GTE,t)}lt(e,t){return this.addRule(e,exports.ApiQueryRuleType.LT,t)}lte(e,t){return this.addRule(e,exports.ApiQueryRuleType.LTE,t)}in(e,t){return this.addRule(e,exports.ApiQueryRuleType.IN,t)}toString(){return JSON.stringify(this.query)}},exports.ApiSort=class{constructor(){this.sort={}}addRule(e,t=exports.ApiSortValue.ASC){return this.sort[e]=t,this}removeRule(e){return delete this.sort[e],this}asc(e){return this.addRule(e,exports.ApiSortValue.ASC)}desc(e){return this.addRule(e,exports.ApiSortValue.DESC)}toString(){return JSON.stringify(this.sort)}},exports.COGNITO_ENDPOINT="https://auth.milkmantechnologies.com/",exports.COGNITO_TOKEN_TIMEOUT=33e5,exports.allIds=(e,t)=>{e.forEach(e=>{e[t]})},exports.byId=e=>e.reduce((e,t)=>{e[t.id]=t},{}),exports.chunks=(e,t)=>{let s=0,r=[];for(;s<e.length;)r.push(e.slice(s,t)),s+=t;return r},exports.defaultHeaders=t,exports.selectId=a,exports.selectIds=(e,t)=>t.map(t=>a(e,t));
//# sourceMappingURL=index.min.js.map
