"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib");require("isomorphic-fetch"),require("abortcontroller-polyfill/dist/abortcontroller-polyfill-only");var t=require("lodash/merge"),r=require("lodash/cloneDeep"),s=require("lodash/isFunction");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=i(t),n=i(r),a=i(s);class h extends Error{constructor(e,t=[]){super(t.length?`${t[0].code}: ${t[0].message}`:"milkman-api-js-client"),this.status=e,this.items=t}}const u=(t,r)=>e.__awaiter(void 0,void 0,void 0,(function*(){var e,t,s;if(!r.response.ok||!(null===(e=r.data)||void 0===e?void 0:e.success)||(null===(t=r.data)||void 0===t?void 0:t.errors)){const e=null===(s=r.data)||void 0===s?void 0:s.errors;throw new h(r.response.status,e)}return r})),l={Accept:"application/json","Content-Type":"application/json"};class c{constructor(e,t){this.controller=new AbortController,this._abort=!1,this._retry=!1,this.meta={},this.originalRequestInfo=e,this.baseUrl=t.baseUrl||"/",this.requestEnhancers=t.requestEnhancers||[],this.responseHandlers=t.responseHandlers||[]}restore(){this._abort=!1,this._retry=!1}stop(){this._abort=!0}retry(){this._retry=!0}composeUrl(e){return`${this.baseUrl.replace(/\/*$/,"")}/${e.replace(/^\/*/,"")}`}composeRequest(e){const t={method:e.method,signal:this.controller.signal,headers:l,body:JSON.stringify(e.data)};return o.default(t,e.options)}applyRequestEnhancers(t){return e.__awaiter(this,void 0,void 0,(function*(){let e=t;for(const t of this.requestEnhancers)e=yield this._execStep(()=>t(e,this));return e}))}applyResponseHandlers(t,r){return e.__awaiter(this,void 0,void 0,(function*(){let e=r;for(const r of this.responseHandlers)e=yield this._execStep(()=>r(t,e,this));return e}))}fetch(t){return e.__awaiter(this,void 0,void 0,(function*(){const e=this.composeUrl(t.path),r=this.composeRequest(t),s=yield this._execStep(()=>fetch(e,r));return{response:s,data:s}}))}_execStep(t){return e.__awaiter(this,void 0,void 0,(function*(){if(this._abort)return null;const e=t();return e.cancel=()=>this._controller.abort(),yield e}))}exec(){return e.__awaiter(this,void 0,void 0,(function*(){this.restore();const e=n.default(this.originalRequestInfo),t=yield this.applyRequestEnhancers(e),r=yield this.fetch(t),s=(yield this.applyResponseHandlers(t,r)).data;return this._retry?this.exec():s}))}}class p{constructor(e={}){this.config=e}fetch(t){return e.__awaiter(this,void 0,void 0,(function*(){return new c(t,this.config).exec()}))}GET(t,r){return e.__awaiter(this,void 0,void 0,(function*(){const e={path:t,method:"GET",options:r};return this.fetch(e)}))}POST(t,r,s){return e.__awaiter(this,void 0,void 0,(function*(){const e={path:t,method:"POST",data:r,options:s};return this.fetch(e)}))}PUT(t,r,s){return e.__awaiter(this,void 0,void 0,(function*(){const e={path:t,method:"PUT",data:r,options:s};return this.fetch(e)}))}PATCH(t,r,s){return e.__awaiter(this,void 0,void 0,(function*(){const e={path:t,method:"PATCH",data:r,options:s};return this.fetch(e)}))}DELETE(t,r){return e.__awaiter(this,void 0,void 0,(function*(){const e={path:t,method:"DELETE",options:r};return this.fetch(e)}))}}const d={errors:[{code:2100}]},_=(t,r)=>e.__awaiter(void 0,void 0,void 0,(function*(){let e;try{const t=yield r.response.json();e=t.hasOwnProperty("result")?t.result:d}catch(t){e=d}return Object.assign(Object.assign({},r),{data:e})}));var A;exports.AuthenticationMethod=void 0,(A=exports.AuthenticationMethod||(exports.AuthenticationMethod={})).USER_PASSWORD="USER_PASSWORD_AUTH",A.REFRESH_TOKEN="REFRESH_TOKEN_AUTH";const m=/(\w*)__(\w*)/;class y{constructor(e){this.type=e.type,this.text=e.text,this.field=e.field,this.value=e.value;const t=m.exec(e.type);this.category=t?t[1]:e.type,this.reason=t?t[2]:null}}class T extends Error{constructor(e,t=[]){super(t.length?`${t[0].type}: ${t[0].text}`:"milkman-api-js-client"),this.status=e,this.items=t.map(e=>new y(e))}}class E{}E.MALFORMED="MALFORMED",E.UNAUTHORIZED="UNAUTHORIZED",E.FORBIDDEN="FORBIDDEN",E.NOT_FOUND="NOT_FOUND",E.CONFLICT="CONFLICT",E.VALIDATION="VALIDATION";var S,f;exports.ApiQueryRuleType=void 0,(S=exports.ApiQueryRuleType||(exports.ApiQueryRuleType={})).EQ="$eq",S.NE="$ne",S.GT="$gt",S.GTE="$gte",S.LT="$lt",S.LTE="$lte",S.IN="$in";exports.ApiSortValue=void 0,(f=exports.ApiSortValue||(exports.ApiSortValue={}))[f.ASC=1]="ASC",f[f.DESC=0]="DESC";var v,x;exports.ApiFilterOperator=void 0,(v=exports.ApiFilterOperator||(exports.ApiFilterOperator={})).EQ="",v.NE="ne",v.GT="gt",v.GE="ge",v.LT="lt",v.LE="le",v.IN="in";exports.ApiSortDirection=void 0,(x=exports.ApiSortDirection||(exports.ApiSortDirection={})).ASC="asc",x.DESC="desc";const O={errors:[{type:E.MALFORMED}]};exports.ApiAuth=class{constructor(e){this.application=e.application,this.clientId=e.clientId,this.automaticRefresh=e.automaticRefresh||!1,this.refreshTimeoutMs=e.refreshTimeoutMs||33e5,this.idTokenStore=e.idTokenStore,this.refreshTokenStore=e.refreshTokenStore,this.useMilkmanSession=e.useMilkmanSession||!1,this.milkmanBaseUrl=e.milkmanBaseUrl||"/",this.sessionTokenStore=e.sessionTokenStore}get cognitoAuthUrl(){return`https://auth.milkmantechnologies.com/${this.application}/login`}get milkmanResolveUserUrl(){return this.milkmanBaseUrl+"/milkman/resolveUser"}_cognitoLogin(e,t){return fetch(this.cognitoAuthUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:exports.AuthenticationMethod.USER_PASSWORD,AuthParameters:{USERNAME:e,PASSWORD:t}})}).then(e=>{if(e.ok)return e.json();throw new Error}).then(({AuthenticationResult:e,error:t})=>{if(!t&&e)return e;throw new Error})}_cognitoRefresh(){return fetch(this.cognitoAuthUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:exports.AuthenticationMethod.REFRESH_TOKEN,AuthParameters:{REFRESH_TOKEN:this.refreshTokenStore.retrieve()}})}).then(e=>{if(e.ok)return e.json();throw new Error}).then(({AuthenticationResult:e,error:t})=>{if(!t&&e)return e;throw new Error})}_resolveUser(){return fetch(this.milkmanBaseUrl+"/milkman/resolveUser?loginSource=Web&rememberMe=true",{method:"GET",headers:Object.assign(Object.assign({},l),{authorization:"Bearer "+this.idTokenStore.retrieve()})}).then(e=>{if(e.ok)return e.json();throw new Error}).then(({session:e})=>{if(e)return e;throw new Error})}scheduleAutomaticRefresh(){this.sessionTimeout&&clearTimeout(this.sessionTimeout),this.sessionTimeout=setTimeout(()=>{this.refresh()},this.refreshTimeoutMs)}login(t,r){return e.__awaiter(this,void 0,void 0,(function*(){const{IdToken:e,RefreshToken:s}=yield this._cognitoLogin(t,r).catch(()=>Promise.reject());if(this.idTokenStore.store(e),this.refreshTokenStore.store(s),this.useMilkmanSession){const e=yield this._resolveUser().catch(()=>Promise.reject());this.sessionTokenStore.store(e)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}refresh(){return e.__awaiter(this,void 0,void 0,(function*(){const{IdToken:e}=yield this._cognitoRefresh().catch(()=>Promise.reject());if(this.idTokenStore.store(e),this.useMilkmanSession){const e=yield this._resolveUser().catch(()=>Promise.reject());this.sessionTokenStore.store(e)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}},exports.ApiError=T,exports.ApiErrorCategory=E,exports.ApiErrorItem=y,exports.ApiExecution=c,exports.ApiFetcher=p,exports.ApiFilters=class{__isReserved(e){return this[e]&&a.default(this[e])}__composeFilterName(e,t=""){return""===t?e:`${e}(${t})`}addFilter(e,t="",r=""){if(e){const s=this.__composeFilterName(e,t);this.__isReserved(s)||(this[s]=r)}return this}removeFilter(e,t=""){if(e){const r=this.__composeFilterName(e,t);this.__isReserved(r)||delete this[r]}return this}eq(e,t){return this.addFilter(e,exports.ApiFilterOperator.EQ,t)}ne(e,t){return this.addFilter(e,exports.ApiFilterOperator.NE,t)}gt(e,t){return this.addFilter(e,exports.ApiFilterOperator.GT,t)}ge(e,t){return this.addFilter(e,exports.ApiFilterOperator.GE,t)}lt(e,t){return this.addFilter(e,exports.ApiFilterOperator.LT,t)}le(e,t){return this.addFilter(e,exports.ApiFilterOperator.LE,t)}in(e,t){return this.addFilter(e,exports.ApiFilterOperator.IN,t)}},exports.ApiLazyLoading=class{constructor(){this.skip=0}reset(){this.skip=0}load(e){const t=`skip=${this.skip}&limit=${e}`;return this.skip+=e,t}},exports.ApiPagination=class{constructor(e){this.pageSize=e}setPageSize(e){this.pageSize=e}page(e){return`skip=${e>0?e*this.pageSize:0}&limit=${this.pageSize}`}},exports.ApiSort=class{constructor(){this.rules=[]}addRule(e,t=exports.ApiSortDirection.ASC){return this.rules.push({name:e,direction:t}),this}asc(e){return this.addRule(e,exports.ApiSortDirection.ASC)}desc(e){return this.addRule(e,exports.ApiSortDirection.DESC)}toString(){return"sort="+this.rules.map(e=>`${e.name}(${e.direction})`).join(",")}},exports.COGNITO_ENDPOINT="https://auth.milkmantechnologies.com/",exports.COGNITO_ID_TOKEN_KEY="MILKMAN_COGNITO_ID_TOKEN",exports.COGNITO_REFRESH_TOKEN_KEY="MILKMAN_COGNITO_REFRESH_TOKEN",exports.COGNITO_TOKEN_TIMEOUT=33e5,exports.ID_PROPERTY="id",exports.LEGACY_SESSION_TOKEN_KEY="MILKMAN_LEGACY_SESSION_TOKEN_KEY",exports.LegacyApiAuth=class{constructor(e){this.baseUrl=e.baseUrl||"/",this.sessionTokenStore=e.sessionTokenStore}get authUrl(){return this.baseUrl+"/milkman/login"}_login(e){return new p({baseUrl:this.baseUrl,responseHandlers:[_,u]}).POST("/milkman/login",e).then(e=>null==e?void 0:e.session)}login(t){return e.__awaiter(this,void 0,void 0,(function*(){const e=yield this._login(t).catch(()=>Promise.reject());return this.sessionTokenStore.store(e),Promise.resolve(!0)}))}},exports.LegacyApiError=h,exports.LegacyApiQuery=class{constructor(){this.query={}}addRule(e,t,r=""){return this.query.hasOwnProperty(e)||(this.query[e]={}),this.query[e][t]=r,this}removeRule(e,t){return this.query.hasOwnProperty(e)&&this.query[e].hasOwnProperty(t)&&(delete this.query[e][t],0===Object.keys(this.query[e]).length&&delete this.query[e]),this}eq(e,t){return this.addRule(e,exports.ApiQueryRuleType.EQ,t)}ne(e,t){return this.addRule(e,exports.ApiQueryRuleType.NE,t)}gt(e,t){return this.addRule(e,exports.ApiQueryRuleType.GT,t)}gte(e,t){return this.addRule(e,exports.ApiQueryRuleType.GTE,t)}lt(e,t){return this.addRule(e,exports.ApiQueryRuleType.LT,t)}lte(e,t){return this.addRule(e,exports.ApiQueryRuleType.LTE,t)}in(e,t){return this.addRule(e,exports.ApiQueryRuleType.IN,t)}toString(){return"query="+JSON.stringify(this.query)}},exports.LegacyApiSort=class{constructor(){this.sort={}}addRule(e,t=exports.ApiSortValue.ASC){return this.sort[e]=t,this}removeRule(e){return delete this.sort[e],this}asc(e){return this.addRule(e,exports.ApiSortValue.ASC)}desc(e){return this.addRule(e,exports.ApiSortValue.DESC)}toString(){return"sort="+JSON.stringify(this.sort)}},exports.SessionTokenStore=class{constructor(e){this.key=e}retrieve(){return sessionStorage.getItem(this.key)}store(e){sessionStorage.setItem(this.key,e)}},exports.apiErrorItemTypeRegex=m,exports.defaultHeaders=l,exports.getAllIds=(e,t="id")=>{const r=[];return e.forEach(e=>{const s=e[t];Array.isArray(s),r.push(s)}),r},exports.injectAuthorizationTokenFactory=t=>r=>e.__awaiter(void 0,void 0,void 0,(function*(){return r.options.headers||(r.options.headers={}),r.options.headers.authorization="Bearer "+t.retrieve(),r})),exports.legacyParseContent=_,exports.legacyThrowError=u,exports.mapById=(e,t="id")=>e.reduce((e,r)=>(e[r[t]]=r,e),{}),exports.parseContent=(t,r)=>e.__awaiter(void 0,void 0,void 0,(function*(){let e;const t=yield r.response.text();if(t)try{e=JSON.parse(t)}catch(t){e=O}return Object.assign(Object.assign({},r),{data:e})})),exports.selectByIds=(e,t)=>t.map(t=>e[t]),exports.splitIntoChunks=(e,t)=>{if(t<=0)return[e];let r=0,s=[];for(;r<e.length;)s.push(e.slice(r,r+t)),r+=t;return s},exports.throwError=(t,r)=>e.__awaiter(void 0,void 0,void 0,(function*(){var e,t;if(!r.response.ok||(null===(e=r.data)||void 0===e?void 0:e.errors)){const e=null===(t=r.data)||void 0===t?void 0:t.errors;throw new T(r.response.status,e)}return r}));
//# sourceMappingURL=index.min.js.map
