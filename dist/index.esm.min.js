import{__rest as e,__awaiter as t}from"tslib";import"isomorphic-fetch";const s={Accept:"application/json","Content-Type":"application/json"};class r{constructor(e={}){this.baseUrl=e.baseUrl||"/",this.enhancers=e.enhancers||[]}composeUrl(e){let t=this.baseUrl.replace(/\/*$/,"");return t+="/"+e.replace(/^\/*/,""),t}composeRequest(t,r={}){const{headers:i}=r,n=e(r,["headers"]),o=Object.assign({method:t,headers:Object.assign(Object.assign({},s),i)},n);return this.enhancers.reduce((e,t)=>t(e),o)}fetch(e,t,s){return fetch(this.composeUrl(t),this.composeRequest(e,s))}get(e,t){return this.fetch("GET",e,t)}post(e,t,s){return this.fetch("POST",e,Object.assign({body:JSON.stringify(t)},s))}put(e,t,s){return this.fetch("PUT",e,Object.assign({body:JSON.stringify(t)},s))}patch(e,t,s){return this.fetch("PATCH",e,Object.assign({body:JSON.stringify(t)},s))}delete(e,t){return this.fetch("DELETE",e,t)}}const i=e=>sessionStorage.setItem("MILMAN_COGNITO_ID_TOKEN",e),n=e=>sessionStorage.setItem("MILMAN_SESSION_TOKEN_KEY",e),o=e=>(e.headers||(e.headers={}),e.headers.Authorization="Bearer "+sessionStorage.getItem("MILMAN_COGNITO_ID_TOKEN"),e),h="https://auth.milkmantechnologies.com/",u=33e5;var a,c,l;!function(e){e.USER_PASSWORD="USER_PASSWORD_AUTH",e.REFRESH_TOKEN="REFRESH_TOKEN_AUTH"}(a||(a={}));class d{constructor(e){this.application=e.application,this.clientId=e.clientId,this.automaticRefresh=e.automaticRefresh||!1,this.refreshTimeoutMs=e.refreshTimeoutMs||33e5,this.useMilkmanSession=e.useMilkmanSession||!1,this.milkmanBaseUrl=e.milkmanBaseUrl||"/"}get authUrl(){return`https://auth.milkmantechnologies.com/${this.application}/login`}_cognitoLogin(e,t){return fetch(this.authUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:a.USER_PASSWORD,AuthParameters:{USERNAME:e,PASSWORD:t}})})}_cognitoRefresh(){return fetch(this.authUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:a.REFRESH_TOKEN,AuthParameters:{REFRESH_TOKEN:sessionStorage.getItem("MILMAN_COGNITO_REFRESH_TOKEN")}})})}_resolveUser(){return new r({baseUrl:this.milkmanBaseUrl,enhancers:[o]}).get("/milkman/resolveUser?loginSource=Web&rememberMe=true")}scheduleAutomaticRefresh(){this.sessionTimeout&&clearTimeout(this.sessionTimeout),this.sessionTimeout=setTimeout(()=>{this.refresh()},this.refreshTimeoutMs)}login(e,s){return t(this,void 0,void 0,(function*(){const{AuthenticationResult:t,error:r}=yield this._cognitoLogin(e,s).then(e=>e.json());if(r||!t)return Promise.reject(r);const{IdToken:o,RefreshToken:h}=t;var u;if(i(o),u=h,sessionStorage.setItem("MILMAN_COGNITO_REFRESH_TOKEN",u),this.useMilkmanSession){const{session:e}=yield this._resolveUser().then(e=>e.json());n(e)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}refresh(){return t(this,void 0,void 0,(function*(){const{AuthenticationResult:e,error:t}=yield this._cognitoRefresh().then(e=>e.json());if(t||!e)return Promise.reject(t);const{IdToken:s}=e;if(i(s),this.useMilkmanSession){const{session:e}=yield this._resolveUser().then(e=>e.json());n(e)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}}!function(e){e.EQ="$eq",e.NE="$ne",e.GT="$gt",e.GTE="$gte",e.LT="$le",e.LTE="$lte",e.IN="$in"}(c||(c={}));class m{constructor(){this.query={}}addRule(e,t,s=""){return this.query.hasOwnProperty(e)||(this.query[e]={}),this.query[e][t]=s,this}removeRule(e,t){return this.query.hasOwnProperty(e)&&this.query[e].hasOwnProperty(t)&&(delete this.query[e][t],0===Object.keys(this.query[e]).length&&delete this.query[e]),this}eq(e,t){return this.addRule(e,c.EQ,t)}ne(e,t){return this.addRule(e,c.NE,t)}gt(e,t){return this.addRule(e,c.GT,t)}gte(e,t){return this.addRule(e,c.GTE,t)}lt(e,t){return this.addRule(e,c.LT,t)}lte(e,t){return this.addRule(e,c.LTE,t)}in(e,t){return this.addRule(e,c.IN,t)}toString(){return JSON.stringify(this.query)}}!function(e){e[e.ASC=1]="ASC",e[e.DESC=0]="DESC"}(l||(l={}));class S{constructor(){this.sort={}}addRule(e,t=l.ASC){return this.sort[e]=t,this}removeRule(e){return delete this.sort[e],this}asc(e){return this.addRule(e,l.ASC)}desc(e){return this.addRule(e,l.DESC)}toString(){return JSON.stringify(this.sort)}}const R=(e,t)=>{let s=0,r=[];for(;s<e.length;)r.push(e.slice(s,t)),s+=t;return r},f=(e,t)=>{e.forEach(e=>{e[t]})},E=e=>e.reduce((e,t)=>{e[t.id]=t},{}),g=(e,t)=>e[t],O=(e,t)=>t.map(t=>g(e,t));export{d as ApiAuth,r as ApiClient,m as ApiQuery,c as ApiQueryRuleType,S as ApiSort,l as ApiSortValue,a as AuthenticationMethod,h as COGNITO_ENDPOINT,u as COGNITO_TOKEN_TIMEOUT,f as allIds,E as byId,R as chunks,s as defaultHeaders,g as selectId,O as selectIds};
//# sourceMappingURL=index.esm.min.js.map
