import{__awaiter as e}from"tslib";import"isomorphic-fetch";import t from"lodash/merge";import s from"lodash/isFunction";const r=/(\w*)__(\w*)/;class i{constructor(e){let t;this.type=e.type,this.text=e.text,this.field=e.field,this.value=e.value,(t=r.test(e.type))&&(this.category=t[1],this.reason=t[2])}}class o extends Error{constructor(e,t=[]){super(t.length?`${t[0].type}: ${t[0].text}`:"milkman-api-js-client"),this.status=e,this.items=t}}const n=(t,s)=>e(void 0,void 0,void 0,(function*(){let e,t=!1;try{e=yield s.json()}catch(e){t=!0}if(s.ok&&!(null==e?void 0:e.errors)||(t=!0),t){const t=null==e?void 0:e.errors;throw new o(s.status,t)}return e}));var h,u;!function(e){e.EQ="$eq",e.NE="$ne",e.GT="$gt",e.GTE="$gte",e.LT="$lt",e.LTE="$lte",e.IN="$in"}(h||(h={}));class l{constructor(){this.query={}}addRule(e,t,s=""){return this.query.hasOwnProperty(e)||(this.query[e]={}),this.query[e][t]=s,this}removeRule(e,t){return this.query.hasOwnProperty(e)&&this.query[e].hasOwnProperty(t)&&(delete this.query[e][t],0===Object.keys(this.query[e]).length&&delete this.query[e]),this}eq(e,t){return this.addRule(e,h.EQ,t)}ne(e,t){return this.addRule(e,h.NE,t)}gt(e,t){return this.addRule(e,h.GT,t)}gte(e,t){return this.addRule(e,h.GTE,t)}lt(e,t){return this.addRule(e,h.LT,t)}lte(e,t){return this.addRule(e,h.LTE,t)}in(e,t){return this.addRule(e,h.IN,t)}toString(){return"query="+JSON.stringify(this.query)}}!function(e){e[e.ASC=1]="ASC",e[e.DESC=0]="DESC"}(u||(u={}));class a{constructor(){this.sort={}}addRule(e,t=u.ASC){return this.sort[e]=t,this}removeRule(e){return delete this.sort[e],this}asc(e){return this.addRule(e,u.ASC)}desc(e){return this.addRule(e,u.DESC)}toString(){return"sort="+JSON.stringify(this.sort)}}class c{constructor(e){this.code=e.code,this.text=e.text,this.field=e.field,this.value=e.value}}class d extends Error{constructor(e,t=[]){super(t.length?`${t[0].code}: ${t[0].text}`:"milkman-api-js-client"),this.status=e,this.items=t}}const m=(t,s)=>e(void 0,void 0,void 0,(function*(){var e,t,r;let i,o=!1;try{i=yield s.json()}catch(e){o=!0}if(s.ok&&(null===(e=null==i?void 0:i.result)||void 0===e?void 0:e.success)&&!(null===(t=null==i?void 0:i.result)||void 0===t?void 0:t.errors)||(o=!0),o){const e=null===(r=null==i?void 0:i.result)||void 0===r?void 0:r.errors;throw new d(s.status,e)}return null==i?void 0:i.result})),p={Accept:"application/json","Content-Type":"application/json"};class E{constructor(e={}){this.baseUrl=e.baseUrl||"/",this.requestEnhancers=e.requestEnhancers||[],this.responseHandlers=e.responseHandlers||[]}composeUrl(e){return`${this.baseUrl.replace(/\/*$/,"")}/${e.replace(/^\/*/,"")}`}applyRequestEnhancers(t,s){return e(this,void 0,void 0,(function*(){return this.requestEnhancers.reduce((t,r)=>e(this,void 0,void 0,(function*(){const e=yield t;return yield r(e,s,this)})),Promise.resolve(t))}))}applyResponseHandlers(t,s,r){return e(this,void 0,void 0,(function*(){return this.responseHandlers.reduce((s,i)=>e(this,void 0,void 0,(function*(){const e=yield s;return yield i(t,e,r,this)})),Promise.resolve(s))}))}composeRequest(s){return e(this,void 0,void 0,(function*(){const e={method:s.method,headers:p,body:JSON.stringify(s.data)},r=t(e,s.options);return this.applyRequestEnhancers(r,s)}))}fetch(t){return e(this,void 0,void 0,(function*(){const e=this.composeUrl(t.path),s=yield this.composeRequest(t),r=yield fetch(e,s);return this.applyResponseHandlers(s,r,t)}))}GET(e,t){const s={path:e,method:"GET",options:t};return this.fetch(s)}POST(e,t,s){const r={path:e,method:"POST",data:t,options:s};return this.fetch(r)}PUT(e,t,s){const r={path:e,method:"PUT",data:t,options:s};return this.fetch(r)}PATCH(e,t,s){const r={path:e,method:"PATCH",data:t,options:s};return this.fetch(r)}DELETE(e,t){const s={path:e,method:"DELETE",options:t};return this.fetch(s)}}var f,S;!function(e){e.EQ="",e.NE="ne",e.GT="gt",e.GE="ge",e.LT="lt",e.LE="le",e.IN="in"}(f||(f={}));class v{__isReserved(e){return this[e]&&s(this[e])}__composeFilterName(e,t=""){return""===t?e:`${e}(${t})`}addFilter(e,t="",s=""){if(e){const r=this.__composeFilterName(e,t);this.__isReserved(r)||(this[r]=s)}return this}removeFilter(e,t=""){if(e){const s=this.__composeFilterName(e,t);this.__isReserved(s)||delete this[s]}return this}eq(e,t){return this.addFilter(e,f.EQ,t)}ne(e,t){return this.addFilter(e,f.NE,t)}gt(e,t){return this.addFilter(e,f.GT,t)}ge(e,t){return this.addFilter(e,f.GE,t)}lt(e,t){return this.addFilter(e,f.LT,t)}le(e,t){return this.addFilter(e,f.LE,t)}in(e,t){return this.addFilter(e,f.IN,t)}}class R{constructor(){this.skip=0}reset(){this.skip=0}load(e){const t=`skip=${this.skip}&limit=${e}`;return this.skip+=e,t}}class g{constructor(e){this.pageSize=e}setPageSize(e){this.pageSize=e}page(e){return`skip=${e>0?e*this.pageSize:0}&limit=${this.pageSize}`}}!function(e){e.ASC="asc",e.DESC="desc"}(S||(S={}));class T{constructor(){this.rules=[]}addRule(e,t=S.ASC){return this.rules.push({name:e,direction:t}),this}asc(e){return this.addRule(e,S.ASC)}desc(e){return this.addRule(e,S.DESC)}toString(){return"sort="+this.rules.map(e=>`${e.name}(${e.direction})`).join(",")}}const _="MILKMAN_COGNITO_ID_TOKEN",y="MILKMAN_COGNITO_REFRESH_TOKEN",N=()=>sessionStorage.getItem("MILKMAN_COGNITO_ID_TOKEN"),O=e=>sessionStorage.setItem("MILKMAN_COGNITO_ID_TOKEN",e),A=()=>sessionStorage.getItem("MILKMAN_COGNITO_REFRESH_TOKEN"),I=e=>sessionStorage.setItem("MILKMAN_COGNITO_REFRESH_TOKEN",e),k="MILKMAN_SESSION_TOKEN_KEY",U=()=>sessionStorage.getItem("MILKMAN_SESSION_TOKEN_KEY"),P=e=>sessionStorage.setItem("MILKMAN_SESSION_TOKEN_KEY",e),w=t=>e(void 0,void 0,void 0,(function*(){return t.headers||(t.headers={}),t.headers.session=U(),t}));class M{constructor(e){this.baseUrl=e.baseUrl||"/"}_login(e){return new E({baseUrl:this.baseUrl}).POST("/milkman/login",e).then(e=>{if(e.ok)return e.json();throw new Error}).then(({result:e})=>{if(e.success&&e.session)return e.session;throw new Error})}login(t){return e(this,void 0,void 0,(function*(){const e=yield this._login(t).catch(()=>Promise.reject());return P(e),Promise.resolve(!0)}))}}const K="https://auth.milkmantechnologies.com/",C=33e5;var $;!function(e){e.USER_PASSWORD="USER_PASSWORD_AUTH",e.REFRESH_TOKEN="REFRESH_TOKEN_AUTH"}($||($={}));class F{constructor(e){this.application=e.application,this.clientId=e.clientId,this.automaticRefresh=e.automaticRefresh||!1,this.refreshTimeoutMs=e.refreshTimeoutMs||33e5,this.useMilkmanSession=e.useMilkmanSession||!1,this.milkmanBaseUrl=e.milkmanBaseUrl||"/"}get cognitoAuthUrl(){return`https://auth.milkmantechnologies.com/${this.application}/login`}get milkmanResolveUserUrl(){return this.milkmanBaseUrl+"/milkman/resolveUser"}_cognitoLogin(e,t){return fetch(this.cognitoAuthUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:$.USER_PASSWORD,AuthParameters:{USERNAME:e,PASSWORD:t}})}).then(e=>{if(e.ok)return e.json();throw new Error}).then(({AuthenticationResult:e,error:t})=>{if(!t&&e)return e;throw new Error})}_cognitoRefresh(){return fetch(this.cognitoAuthUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:$.REFRESH_TOKEN,AuthParameters:{REFRESH_TOKEN:A()}})}).then(e=>{if(e.ok)return e.json();throw new Error}).then(({AuthenticationResult:e,error:t})=>{if(!t&&e)return e;throw new Error})}_resolveUser(){return fetch(this.milkmanBaseUrl+"/milkman/resolveUser?loginSource=Web&rememberMe=true",{method:"GET",headers:Object.assign(Object.assign({},p),{authorization:"Bearer "+N()})}).then(e=>{if(e.ok)return e.json();throw new Error}).then(({session:e})=>{if(e)return e;throw new Error})}scheduleAutomaticRefresh(){this.sessionTimeout&&clearTimeout(this.sessionTimeout),this.sessionTimeout=setTimeout(()=>{this.refresh()},this.refreshTimeoutMs)}login(t,s){return e(this,void 0,void 0,(function*(){const{IdToken:e,RefreshToken:r}=yield this._cognitoLogin(t,s).catch(()=>Promise.reject());if(O(e),I(r),this.useMilkmanSession){const e=yield this._resolveUser().catch(()=>Promise.reject());P(e)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}refresh(){return e(this,void 0,void 0,(function*(){const{IdToken:e}=yield this._cognitoRefresh().catch(()=>Promise.reject());if(O(e),this.useMilkmanSession){const e=yield this._resolveUser().catch(()=>Promise.reject());P(e)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}}const j=t=>e(void 0,void 0,void 0,(function*(){return t.headers||(t.headers={}),t.headers.authorization="Bearer "+N(),t})),q="id",L=(e,t="id")=>{const s=[];return e.forEach(e=>{const r=e[t];Array.isArray(r),s.push(r)}),s},G=(e,t="id")=>e.reduce((e,s)=>(e[s[t]]=s,e),{}),b=(e,t)=>t.map(t=>e[t]),H=(e,t)=>{if(t<=0)return[e];let s=0,r=[];for(;s<e.length;)r.push(e.slice(s,s+t)),s+=t;return r};export{F as ApiAuth,o as ApiError,i as ApiErrorItem,E as ApiFetch,f as ApiFilterOperator,v as ApiFilters,R as ApiLazyLoading,g as ApiPagination,h as ApiQueryRuleType,T as ApiSort,S as ApiSortDirection,u as ApiSortValue,$ as AuthenticationMethod,K as COGNITO_ENDPOINT,_ as COGNITO_ID_TOKEN_KEY,y as COGNITO_REFRESH_TOKEN_KEY,C as COGNITO_TOKEN_TIMEOUT,q as ID_PROPERTY,M as LegacyApiAuth,d as LegacyApiError,c as LegacyApiErrorItem,l as LegacyApiQuery,a as LegacyApiSort,k as SESSION_TOKEN_KEY,r as apiErrorItemTypeRegex,p as defaultHeaders,L as getAllIds,j as injectAuthorizationToken,w as injectLegacySessionToken,m as legacyParseContentOrThrowError,G as mapById,n as parseContentOrThrowError,N as retrieveIdToken,A as retrieveRefreshToken,U as retrieveSessionToken,b as selectByIds,H as splitIntoChunks,O as storeIdToken,I as storeRefreshToken,P as storeSessionToken};
//# sourceMappingURL=index.esm.min.js.map
