import"isomorphic-fetch";import e from"lodash/merge";import t from"lodash/isFunction";import{__awaiter as r}from"tslib";const s={Accept:"application/json","Content-Type":"application/json"};class i{constructor(e={}){this.baseUrl=e.baseUrl||"/",this.enhancers=e.enhancers||[]}composeUrl(e){let t=this.baseUrl.replace(/\/*$/,"");return t+="/"+e.replace(/^\/*/,""),t}composeRequest(t,r={}){const i=e({method:t,headers:s},r);return this.enhancers.reduce((e,t)=>t(e),i)}fetch(e,t,r){return fetch(this.composeUrl(t),this.composeRequest(e,r))}GET(e,t){return this.fetch("GET",e,t)}POST(e,t,r){return this.fetch("POST",e,Object.assign({body:JSON.stringify(t)},r))}PUT(e,t,r){return this.fetch("PUT",e,Object.assign({body:JSON.stringify(t)},r))}PATCH(e,t,r){return this.fetch("PATCH",e,Object.assign({body:JSON.stringify(t)},r))}DELETE(e,t){return this.fetch("DELETE",e,t)}}var n,o,h,u;!function(e){e.EQ="",e.NE="ne",e.GT="gt",e.GE="ge",e.LT="lt",e.LE="le",e.IN="in"}(n||(n={}));class a{__isReserved(e){return this[e]&&t(this[e])}__composeFilterName(e,t=""){return""===t?e:`${e}(${t})`}addFilter(e,t="",r=""){if(e){const s=this.__composeFilterName(e,t);this.__isReserved(s)||(this[s]=r)}return this}removeFilter(e,t=""){if(e){const r=this.__composeFilterName(e,t);this.__isReserved(r)||delete this[r]}return this}eq(e,t){return this.addFilter(e,n.EQ,t)}ne(e,t){return this.addFilter(e,n.NE,t)}gt(e,t){return this.addFilter(e,n.GT,t)}ge(e,t){return this.addFilter(e,n.GE,t)}lt(e,t){return this.addFilter(e,n.LT,t)}le(e,t){return this.addFilter(e,n.LE,t)}in(e,t){return this.addFilter(e,n.IN,t)}}!function(e){e.ASC="asc",e.DESC="desc"}(o||(o={}));class c{constructor(){this.rules=[]}addRule(e,t=o.ASC){return this.rules.push({name:e,direction:t}),this}asc(e){return this.addRule(e,o.ASC)}desc(e){return this.addRule(e,o.DESC)}toString(){return"sort="+this.rules.map(e=>`${e.name}(${e.direction})`).join(",")}}class l{constructor(e){this.pageSize=e}setPageSize(e){this.pageSize=e}page(e){return`skip=${e>0?e*this.pageSize:0}&limit=${this.pageSize}`}}class d{constructor(e=0){this.skip=0,this.limit=e}setLimit(e){this.limit=e}skipMore(e){this.skip+=e}toString(){return`skip=${this.skip}&limit=${this.limit}`}}!function(e){e.EQ="$eq",e.NE="$ne",e.GT="$gt",e.GTE="$gte",e.LT="$lt",e.LTE="$lte",e.IN="$in"}(h||(h={}));class m{constructor(){this.query={}}addRule(e,t,r=""){return this.query.hasOwnProperty(e)||(this.query[e]={}),this.query[e][t]=r,this}removeRule(e,t){return this.query.hasOwnProperty(e)&&this.query[e].hasOwnProperty(t)&&(delete this.query[e][t],0===Object.keys(this.query[e]).length&&delete this.query[e]),this}eq(e,t){return this.addRule(e,h.EQ,t)}ne(e,t){return this.addRule(e,h.NE,t)}gt(e,t){return this.addRule(e,h.GT,t)}gte(e,t){return this.addRule(e,h.GTE,t)}lt(e,t){return this.addRule(e,h.LT,t)}lte(e,t){return this.addRule(e,h.LTE,t)}in(e,t){return this.addRule(e,h.IN,t)}toString(){return"query="+JSON.stringify(this.query)}}!function(e){e[e.ASC=1]="ASC",e[e.DESC=0]="DESC"}(u||(u={}));class E{constructor(){this.sort={}}addRule(e,t=u.ASC){return this.sort[e]=t,this}removeRule(e){return delete this.sort[e],this}asc(e){return this.addRule(e,u.ASC)}desc(e){return this.addRule(e,u.DESC)}toString(){return"sort="+JSON.stringify(this.sort)}}const S="MILMAN_COGNITO_ID_TOKEN",g="MILMAN_COGNITO_REFRESH_TOKEN",f=()=>sessionStorage.getItem("MILMAN_COGNITO_ID_TOKEN"),T=e=>sessionStorage.setItem("MILMAN_COGNITO_ID_TOKEN",e),_=()=>sessionStorage.getItem("MILMAN_COGNITO_REFRESH_TOKEN"),R=e=>sessionStorage.setItem("MILMAN_COGNITO_REFRESH_TOKEN",e),p="MILMAN_SESSION_TOKEN_KEY",O=()=>sessionStorage.getItem("MILMAN_SESSION_TOKEN_KEY"),N=e=>sessionStorage.setItem("MILMAN_SESSION_TOKEN_KEY",e),A="https://auth.milkmantechnologies.com/",I=33e5;var y;!function(e){e.USER_PASSWORD="USER_PASSWORD_AUTH",e.REFRESH_TOKEN="REFRESH_TOKEN_AUTH"}(y||(y={}));class U{constructor(e){this.application=e.application,this.clientId=e.clientId,this.automaticRefresh=e.automaticRefresh||!1,this.refreshTimeoutMs=e.refreshTimeoutMs||33e5,this.useMilkmanSession=e.useMilkmanSession||!1,this.milkmanBaseUrl=e.milkmanBaseUrl||"/"}get cognitoAuthUrl(){return`https://auth.milkmantechnologies.com/${this.application}/login`}get milkmanResolveUserUrl(){return this.milkmanBaseUrl+"/milkman/resolveUser"}_cognitoLogin(e,t){return fetch(this.cognitoAuthUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:y.USER_PASSWORD,AuthParameters:{USERNAME:e,PASSWORD:t}})}).then(e=>{if(e.ok)return e.json();throw new Error}).then(({AuthenticationResult:e,error:t})=>{if(!t&&e)return e;throw new Error})}_cognitoRefresh(){return fetch(this.cognitoAuthUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:y.REFRESH_TOKEN,AuthParameters:{REFRESH_TOKEN:_()}})}).then(e=>{if(e.ok)return e.json();throw new Error}).then(({AuthenticationResult:e,error:t})=>{if(!t&&e)return e;throw new Error})}_resolveUser(){return fetch(this.milkmanBaseUrl+"/milkman/resolveUser?loginSource=Web&rememberMe=true",{method:"GET",headers:Object.assign(Object.assign({},s),{authorization:"Bearer "+f()})}).then(e=>{if(e.ok)return e.json();throw new Error}).then(({session:e})=>{if(e)return e;throw new Error})}scheduleAutomaticRefresh(){this.sessionTimeout&&clearTimeout(this.sessionTimeout),this.sessionTimeout=setTimeout(()=>{this.refresh()},this.refreshTimeoutMs)}login(e,t){return r(this,void 0,void 0,(function*(){const{IdToken:r,RefreshToken:s}=yield this._cognitoLogin(e,t).catch(()=>Promise.reject());if(T(r),R(s),this.useMilkmanSession){const e=yield this._resolveUser().catch(()=>Promise.reject());N(e)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}refresh(){return r(this,void 0,void 0,(function*(){const{IdToken:e}=yield this._cognitoRefresh().catch(()=>Promise.reject());if(T(e),this.useMilkmanSession){const e=yield this._resolveUser().catch(()=>Promise.reject());N(e)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}}const M=e=>(e.headers||(e.headers={}),e.headers.authorization="Bearer "+f(),e);class k{constructor(e){this.baseUrl=e.baseUrl||"/"}_login(e){return new i({baseUrl:this.baseUrl}).POST("/milkman/login",Object.assign({rememberMe:!0,loginSource:"Web"},e)).then(e=>{if(e.ok)return e.json();throw new Error}).then(({result:e})=>{if(e.success&&e.session)return e.session;throw new Error})}login(e){return r(this,void 0,void 0,(function*(){const t=yield this._login(e).catch(()=>Promise.reject());return N(t),Promise.resolve(!0)}))}}const P=e=>(e.headers||(e.headers={}),e.headers.session=O(),e),b="id",v=(e,t)=>{if(t<=0)return[e];let r=0,s=[];for(;r<e.length;)s.push(e.slice(r,r+t)),r+=t;return s},C=(e,t="id")=>{const r=[];return e.forEach(e=>{const s=e[t];Array.isArray(s),r.push(s)}),r},w=(e,t="id")=>e.reduce((e,r)=>(e[r[t]]=r,e),{}),F=(e,t)=>t.map(t=>e[t]);export{U as ApiAuth,i as ApiClient,n as ApiFilterOperator,a as ApiFilters,d as ApiLazyLoading,l as ApiPagination,h as ApiQueryRuleType,c as ApiSort,o as ApiSortDirection,u as ApiSortValue,y as AuthenticationMethod,A as COGNITO_ENDPOINT,S as COGNITO_ID_TOKEN_KEY,g as COGNITO_REFRESH_TOKEN_KEY,I as COGNITO_TOKEN_TIMEOUT,b as ID_PROPERTY,k as LegacyApiAuth,m as LegacyApiQuery,E as LegacyApiSort,p as SESSION_TOKEN_KEY,C as allIds,M as authEnhancer,w as byId,v as chunks,s as defaultHeaders,P as legacyAuthEnhancer,f as retrieveIdToken,_ as retrieveRefreshToken,O as retrieveSessionToken,F as selectIds,T as storeIdToken,R as storeRefreshToken,N as storeSessionToken};
//# sourceMappingURL=index.esm.min.js.map
