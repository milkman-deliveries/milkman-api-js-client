import{__awaiter as e}from"tslib";import"isomorphic-fetch";import"abortcontroller-polyfill/dist/abortcontroller-polyfill-only";import t from"lodash/merge";import s from"lodash/isFunction";const r=t=>s=>e(void 0,void 0,void 0,(function*(){return s.options.headers||(s.options.headers={}),s.options.headers.session=t.retrieve(),s}));class i extends Error{constructor(e,t=[]){super(t.length?`${t[0].code}: ${t[0].message}`:"milkman-api-js-client"),this.status=e,this.items=t}}const o=t=>e(void 0,void 0,void 0,(function*(){var e,s,r;if(!t.response.ok||!(null===(e=t.responseData)||void 0===e?void 0:e.success)||(null===(s=t.responseData)||void 0===s?void 0:s.errors)){const e=null===(r=t.responseData)||void 0===r?void 0:r.errors;throw new i(t.response.status,e)}return t})),n=(t,s)=>e(void 0,void 0,void 0,(function*(){return t.cancel=()=>s.abort(),t})),h={Accept:"application/json","Content-Type":"application/json"};class a{constructor(e={}){this.baseUrl=e.baseUrl||"/",this.requestEnhancers=e.requestEnhancers||[],this.responseHandlers=e.responseHandlers||[]}composeUrl(e){return`${this.baseUrl.replace(/\/*$/,"")}/${e.replace(/^\/*/,"")}`}enhanceRequestInfo(t){return e(this,void 0,void 0,(function*(){let e=t;for(const t of this.requestEnhancers)e=yield t(e,this);return e}))}applyResponseHandlers(t){return e(this,void 0,void 0,(function*(){let e=t;for(const t of this.responseHandlers)e=yield t(e,this);return e}))}composeRequest(e,s){const r={method:e.method,signal:s,headers:h,body:JSON.stringify(e.requestData)};return t(r,e.options)}_prefetch(t,s){return e(this,void 0,void 0,(function*(){return n(this.enhanceRequestInfo(t),s)}))}_fetch(t,s){return e(this,void 0,void 0,(function*(){const e=this.composeUrl(t.path),r=this.composeRequest(t,s.signal),i=yield n(fetch(e,r),s);return Object.assign(Object.assign({},t),{response:i})}))}_postfetch(t,s){return e(this,void 0,void 0,(function*(){return n(this.applyResponseHandlers(t),s)}))}fetch(t){return e(this,void 0,void 0,(function*(){const e=new AbortController,s=yield this._prefetch(t,e),r=yield this._fetch(s,e);return(yield this._postfetch(r,e)).responseData}))}GET(e,t,s){const r={path:e,method:"GET",options:t,meta:s};return this.fetch(r)}POST(e,t,s,r){const i={path:e,method:"POST",requestData:t,options:s,meta:r};return this.fetch(i)}PUT(e,t,s,r){const i={path:e,method:"PUT",requestData:t,options:s,meta:r};return this.fetch(i)}PATCH(e,t,s,r){const i={path:e,method:"PATCH",requestData:t,options:s,meta:r};return this.fetch(i)}DELETE(e,t,s){const r={path:e,method:"DELETE",options:t,meta:s};return this.fetch(r)}}const c={errors:[{code:2100}]},u=t=>e(void 0,void 0,void 0,(function*(){let e;try{const s=yield t.response.json();e=s.hasOwnProperty("result")?s.result:c}catch(t){e=c}return Object.assign(Object.assign({},t),{responseData:e})})),l="MILKMAN_LEGACY_SESSION_TOKEN_KEY";class d{constructor(e){this.baseUrl=e.baseUrl||"/",this.sessionTokenStore=e.sessionTokenStore}get authUrl(){return this.baseUrl+"/milkman/login"}_login(e){return new a({baseUrl:this.baseUrl,responseHandlers:[u,o]}).POST("/milkman/login",e).then(e=>null==e?void 0:e.session)}login(t){return e(this,void 0,void 0,(function*(){const e=yield this._login(t).catch(()=>Promise.reject());return this.sessionTokenStore.store(e),Promise.resolve(!0)}))}}const p="https://auth.milkmantechnologies.com/",m=33e5,f="MILKMAN_COGNITO_ID_TOKEN",v="MILKMAN_COGNITO_REFRESH_TOKEN";var E;!function(e){e.USER_PASSWORD="USER_PASSWORD_AUTH",e.REFRESH_TOKEN="REFRESH_TOKEN_AUTH"}(E||(E={}));class S{constructor(e){this.application=e.application,this.clientId=e.clientId,this.automaticRefresh=e.automaticRefresh||!1,this.refreshTimeoutMs=e.refreshTimeoutMs||33e5,this.idTokenStore=e.idTokenStore,this.refreshTokenStore=e.refreshTokenStore,this.useMilkmanSession=e.useMilkmanSession||!1,this.milkmanBaseUrl=e.milkmanBaseUrl||"/",this.sessionTokenStore=e.sessionTokenStore}get cognitoAuthUrl(){return`https://auth.milkmantechnologies.com/${this.application}/login`}get milkmanResolveUserUrl(){return this.milkmanBaseUrl+"/milkman/resolveUser"}_cognitoLogin(e,t){return fetch(this.cognitoAuthUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:E.USER_PASSWORD,AuthParameters:{USERNAME:e,PASSWORD:t}})}).then(e=>{if(e.ok)return e.json();throw new Error}).then(({AuthenticationResult:e,error:t})=>{if(!t&&e)return e;throw new Error})}_cognitoRefresh(){return fetch(this.cognitoAuthUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:E.REFRESH_TOKEN,AuthParameters:{REFRESH_TOKEN:this.refreshTokenStore.retrieve()}})}).then(e=>{if(e.ok)return e.json();throw new Error}).then(({AuthenticationResult:e,error:t})=>{if(!t&&e)return e;throw new Error})}_resolveUser(){return fetch(this.milkmanBaseUrl+"/milkman/resolveUser?loginSource=Web&rememberMe=true",{method:"GET",headers:Object.assign(Object.assign({},h),{authorization:"Bearer "+this.idTokenStore.retrieve()})}).then(e=>{if(e.ok)return e.json();throw new Error}).then(({session:e})=>{if(e)return e;throw new Error})}scheduleAutomaticRefresh(){this.sessionTimeout&&clearTimeout(this.sessionTimeout),this.sessionTimeout=setTimeout(()=>{this.refresh()},this.refreshTimeoutMs)}login(t,s){return e(this,void 0,void 0,(function*(){const{IdToken:e,RefreshToken:r}=yield this._cognitoLogin(t,s).catch(()=>Promise.reject());if(this.idTokenStore.store(e),this.refreshTokenStore.store(r),this.useMilkmanSession){const e=yield this._resolveUser().catch(()=>Promise.reject());this.sessionTokenStore.store(e)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}refresh(){return e(this,void 0,void 0,(function*(){const{IdToken:e}=yield this._cognitoRefresh().catch(()=>Promise.reject());if(this.idTokenStore.store(e),this.useMilkmanSession){const e=yield this._resolveUser().catch(()=>Promise.reject());this.sessionTokenStore.store(e)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}}const T=t=>s=>e(void 0,void 0,void 0,(function*(){return s.options.headers||(s.options.headers={}),s.options.headers.authorization="Bearer "+t.retrieve(),s})),g=/(\w*)__(\w*)/;class R{constructor(e){this.type=e.type,this.text=e.text,this.field=e.field,this.value=e.value;const t=g.exec(e.type);this.category=t?t[1]:e.type,this.reason=t?t[2]:null}}class y extends Error{constructor(e,t=[]){super(t.length?`${t[0].type}: ${t[0].text}`:"milkman-api-js-client"),this.status=e,this.items=t.map(e=>new R(e))}}class O{}O.MALFORMED="MALFORMED",O.UNAUTHORIZED="UNAUTHORIZED",O.FORBIDDEN="FORBIDDEN",O.NOT_FOUND="NOT_FOUND",O.CONFLICT="CONFLICT",O.VALIDATION="VALIDATION";const k=t=>e(void 0,void 0,void 0,(function*(){var e,s;if(!t.response.ok||(null===(e=t.responseData)||void 0===e?void 0:e.errors)){const e=null===(s=t.responseData)||void 0===s?void 0:s.errors;throw new y(t.response.status,e)}return t}));var _,A;!function(e){e.EQ="$eq",e.NE="$ne",e.GT="$gt",e.GTE="$gte",e.LT="$lt",e.LTE="$lte",e.IN="$in"}(_||(_={}));class N{constructor(){this.query={}}addRule(e,t,s=""){return this.query.hasOwnProperty(e)||(this.query[e]={}),this.query[e][t]=s,this}removeRule(e,t){return this.query.hasOwnProperty(e)&&this.query[e].hasOwnProperty(t)&&(delete this.query[e][t],0===Object.keys(this.query[e]).length&&delete this.query[e]),this}eq(e,t){return this.addRule(e,_.EQ,t)}ne(e,t){return this.addRule(e,_.NE,t)}gt(e,t){return this.addRule(e,_.GT,t)}gte(e,t){return this.addRule(e,_.GTE,t)}lt(e,t){return this.addRule(e,_.LT,t)}lte(e,t){return this.addRule(e,_.LTE,t)}in(e,t){return this.addRule(e,_.IN,t)}toString(){return"query="+JSON.stringify(this.query)}}!function(e){e[e.ASC=1]="ASC",e[e.DESC=0]="DESC"}(A||(A={}));class U{constructor(){this.sort={}}addRule(e,t=A.ASC){return this.sort[e]=t,this}removeRule(e){return delete this.sort[e],this}asc(e){return this.addRule(e,A.ASC)}desc(e){return this.addRule(e,A.DESC)}toString(){return"sort="+JSON.stringify(this.sort)}}const D="id";var I,F;!function(e){e.EQ="",e.NE="ne",e.GT="gt",e.GE="ge",e.LT="lt",e.LE="le",e.IN="in"}(I||(I={}));class P{__isReserved(e){return this[e]&&s(this[e])}__composeFilterName(e,t=""){return""===t?e:`${e}(${t})`}addFilter(e,t="",s=""){if(e){const r=this.__composeFilterName(e,t);this.__isReserved(r)||(this[r]=s)}return this}removeFilter(e,t=""){if(e){const s=this.__composeFilterName(e,t);this.__isReserved(s)||delete this[s]}return this}eq(e,t){return this.addFilter(e,I.EQ,t)}ne(e,t){return this.addFilter(e,I.NE,t)}gt(e,t){return this.addFilter(e,I.GT,t)}ge(e,t){return this.addFilter(e,I.GE,t)}lt(e,t){return this.addFilter(e,I.LT,t)}le(e,t){return this.addFilter(e,I.LE,t)}in(e,t){return this.addFilter(e,I.IN,t)}}class b{constructor(){this.skip=0}reset(){this.skip=0}load(e){const t=`skip=${this.skip}&limit=${e}`;return this.skip+=e,t}}class w{constructor(e){this.pageSize=e}setPageSize(e){this.pageSize=e}page(e){return`skip=${e>0?e*this.pageSize:0}&limit=${this.pageSize}`}}!function(e){e.ASC="asc",e.DESC="desc"}(F||(F={}));class j{constructor(){this.rules=[]}addRule(e,t=F.ASC){return this.rules.push({name:e,direction:t}),this}asc(e){return this.addRule(e,F.ASC)}desc(e){return this.addRule(e,F.DESC)}toString(){return"sort="+this.rules.map(e=>`${e.name}(${e.direction})`).join(",")}}const q={errors:[{type:O.MALFORMED}]},C=t=>e(void 0,void 0,void 0,(function*(){let e;const s=yield t.response.text();if(s)try{e=JSON.parse(s)}catch(t){e=q}return Object.assign(Object.assign({},t),{responseData:e})}));class L{constructor(e){this.key=e}retrieve(){return sessionStorage.getItem(this.key)}store(e){sessionStorage.setItem(this.key,e)}}const $=(e,t="id")=>{const s=[];return e.forEach(e=>{const r=e[t];Array.isArray(r),s.push(r)}),s},M=(e,t="id")=>e.reduce((e,s)=>(e[s[t]]=s,e),{}),H=(e,t)=>t.map(t=>e[t]),G=(e,t)=>{if(t<=0)return[e];let s=0,r=[];for(;s<e.length;)r.push(e.slice(s,s+t)),s+=t;return r};export{S as ApiAuth,y as ApiError,O as ApiErrorCategory,R as ApiErrorItem,a as ApiFetch,I as ApiFilterOperator,P as ApiFilters,b as ApiLazyLoading,w as ApiPagination,_ as ApiQueryRuleType,j as ApiSort,F as ApiSortDirection,A as ApiSortValue,E as AuthenticationMethod,p as COGNITO_ENDPOINT,f as COGNITO_ID_TOKEN_KEY,v as COGNITO_REFRESH_TOKEN_KEY,m as COGNITO_TOKEN_TIMEOUT,D as ID_PROPERTY,l as LEGACY_SESSION_TOKEN_KEY,d as LegacyApiAuth,i as LegacyApiError,N as LegacyApiQuery,U as LegacyApiSort,L as SessionTokenStore,g as apiErrorItemTypeRegex,h as defaultHeaders,$ as getAllIds,T as injectAuthorizationTokenFactory,r as injectLegacySessionTokenFactory,u as legacyParseContent,o as legacyThrowError,M as mapById,C as parseContent,H as selectByIds,G as splitIntoChunks,k as throwError};
//# sourceMappingURL=index.esm.min.js.map
