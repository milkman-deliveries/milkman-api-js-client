import{__awaiter as t}from"tslib";import"isomorphic-fetch";import"abortcontroller-polyfill/dist/abortcontroller-polyfill-only";import e from"lodash/merge";import s from"lodash/cloneDeep";import r from"lodash/isFunction";class i extends Error{constructor(t,e=[]){super(e.length?`${e[0].code}: ${e[0].message}`:"milkman-api-js-client"),this.status=t,this.items=e}}const o=(e,s)=>t(void 0,void 0,void 0,(function*(){var t,e,r;if(!s.response.ok||!(null===(t=s.data)||void 0===t?void 0:t.success)||(null===(e=s.data)||void 0===e?void 0:e.errors)){const t=null===(r=s.data)||void 0===r?void 0:r.errors;throw new i(s.response.status,t)}return s})),n={Accept:"application/json","Content-Type":"application/json"};class h{constructor(t,e){this.controller=new AbortController,this._abort=!1,this._retry=!1,this.meta={},this.originalRequestInfo=t,this.baseUrl=e.baseUrl||"/",this.requestEnhancers=e.requestEnhancers||[],this.responseHandlers=e.responseHandlers||[]}restore(){this._abort=!1,this._retry=!1}stop(){this._abort=!0}retry(){this._retry=!0}composeUrl(t){return`${this.baseUrl.replace(/\/*$/,"")}/${t.replace(/^\/*/,"")}`}composeRequest(t){const s={method:t.method,signal:this.controller.signal,headers:n,body:JSON.stringify(t.data)};return e(s,t.options)}applyRequestEnhancers(e){return t(this,void 0,void 0,(function*(){let t=e;for(const e of this.requestEnhancers)t=yield this._execStep(()=>e(t,this));return t}))}applyResponseHandlers(e,s){return t(this,void 0,void 0,(function*(){let t=s;for(const s of this.responseHandlers)t=yield this._execStep(()=>s(e,t,this));return t}))}fetch(e){return t(this,void 0,void 0,(function*(){const t=this.composeUrl(e.path),s=this.composeRequest(e),r=yield this._execStep(()=>fetch(t,s));return{response:r,data:r}}))}_execStep(e){return t(this,void 0,void 0,(function*(){if(this._abort)return null;const t=e();return t.cancel=()=>this._controller.abort(),yield t}))}exec(){return t(this,void 0,void 0,(function*(){this.restore();const t=s(this.originalRequestInfo),e=yield this.applyRequestEnhancers(t),r=yield this.fetch(e),i=(yield this.applyResponseHandlers(e,r)).data;return this._retry?this.exec():i}))}}class a{constructor(t={}){this.config=t}fetch(e){return t(this,void 0,void 0,(function*(){return new h(e,this.config).exec()}))}GET(e,s){return t(this,void 0,void 0,(function*(){const t={path:e,method:"GET",options:s};return this.fetch(t)}))}POST(e,s,r){return t(this,void 0,void 0,(function*(){const t={path:e,method:"POST",data:s,options:r};return this.fetch(t)}))}PUT(e,s,r){return t(this,void 0,void 0,(function*(){const t={path:e,method:"PUT",data:s,options:r};return this.fetch(t)}))}PATCH(e,s,r){return t(this,void 0,void 0,(function*(){const t={path:e,method:"PATCH",data:s,options:r};return this.fetch(t)}))}DELETE(e,s){return t(this,void 0,void 0,(function*(){const t={path:e,method:"DELETE",options:s};return this.fetch(t)}))}}const c={errors:[{code:2100}]},l=(e,s)=>t(void 0,void 0,void 0,(function*(){let t;try{const e=yield s.response.json();t=e.hasOwnProperty("result")?e.result:c}catch(e){t=c}return Object.assign(Object.assign({},s),{data:t})})),u="MILKMAN_LEGACY_SESSION_TOKEN_KEY";class d{constructor(t){this.baseUrl=t.baseUrl||"/",this.sessionTokenStore=t.sessionTokenStore}get authUrl(){return this.baseUrl+"/milkman/login"}_login(t){return new a({baseUrl:this.baseUrl,responseHandlers:[l,o]}).POST("/milkman/login",t).then(t=>null==t?void 0:t.session)}login(e){return t(this,void 0,void 0,(function*(){const t=yield this._login(e).catch(()=>Promise.reject());return this.sessionTokenStore.store(t),Promise.resolve(!0)}))}}const p="https://auth.milkmantechnologies.com/",m=33e5,f="MILKMAN_COGNITO_ID_TOKEN",v="MILKMAN_COGNITO_REFRESH_TOKEN";var S;!function(t){t.USER_PASSWORD="USER_PASSWORD_AUTH",t.REFRESH_TOKEN="REFRESH_TOKEN_AUTH"}(S||(S={}));class E{constructor(t){this.application=t.application,this.clientId=t.clientId,this.automaticRefresh=t.automaticRefresh||!1,this.refreshTimeoutMs=t.refreshTimeoutMs||33e5,this.idTokenStore=t.idTokenStore,this.refreshTokenStore=t.refreshTokenStore,this.useMilkmanSession=t.useMilkmanSession||!1,this.milkmanBaseUrl=t.milkmanBaseUrl||"/",this.sessionTokenStore=t.sessionTokenStore}get cognitoAuthUrl(){return`https://auth.milkmantechnologies.com/${this.application}/login`}get milkmanResolveUserUrl(){return this.milkmanBaseUrl+"/milkman/resolveUser"}_cognitoLogin(t,e){return fetch(this.cognitoAuthUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:S.USER_PASSWORD,AuthParameters:{USERNAME:t,PASSWORD:e}})}).then(t=>{if(t.ok)return t.json();throw new Error}).then(({AuthenticationResult:t,error:e})=>{if(!e&&t)return t;throw new Error})}_cognitoRefresh(){return fetch(this.cognitoAuthUrl,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify({ClientId:this.clientId,AuthFlow:S.REFRESH_TOKEN,AuthParameters:{REFRESH_TOKEN:this.refreshTokenStore.retrieve()}})}).then(t=>{if(t.ok)return t.json();throw new Error}).then(({AuthenticationResult:t,error:e})=>{if(!e&&t)return t;throw new Error})}_resolveUser(){return fetch(this.milkmanBaseUrl+"/milkman/resolveUser?loginSource=Web&rememberMe=true",{method:"GET",headers:Object.assign(Object.assign({},n),{authorization:"Bearer "+this.idTokenStore.retrieve()})}).then(t=>{if(t.ok)return t.json();throw new Error}).then(({session:t})=>{if(t)return t;throw new Error})}scheduleAutomaticRefresh(){this.sessionTimeout&&clearTimeout(this.sessionTimeout),this.sessionTimeout=setTimeout(()=>{this.refresh()},this.refreshTimeoutMs)}login(e,s){return t(this,void 0,void 0,(function*(){const{IdToken:t,RefreshToken:r}=yield this._cognitoLogin(e,s).catch(()=>Promise.reject());if(this.idTokenStore.store(t),this.refreshTokenStore.store(r),this.useMilkmanSession){const t=yield this._resolveUser().catch(()=>Promise.reject());this.sessionTokenStore.store(t)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}refresh(){return t(this,void 0,void 0,(function*(){const{IdToken:t}=yield this._cognitoRefresh().catch(()=>Promise.reject());if(this.idTokenStore.store(t),this.useMilkmanSession){const t=yield this._resolveUser().catch(()=>Promise.reject());this.sessionTokenStore.store(t)}return this.automaticRefresh&&this.scheduleAutomaticRefresh(),Promise.resolve(!0)}))}}const T=e=>s=>t(void 0,void 0,void 0,(function*(){return s.options.headers||(s.options.headers={}),s.options.headers.authorization="Bearer "+e.retrieve(),s})),g=/(\w*)__(\w*)/;class y{constructor(t){this.type=t.type,this.text=t.text,this.field=t.field,this.value=t.value;const e=g.exec(t.type);this.category=e?e[1]:t.type,this.reason=e?e[2]:null}}class R extends Error{constructor(t,e=[]){super(e.length?`${e[0].type}: ${e[0].text}`:"milkman-api-js-client"),this.status=t,this.items=e.map(t=>new y(t))}}class _{}_.MALFORMED="MALFORMED",_.UNAUTHORIZED="UNAUTHORIZED",_.FORBIDDEN="FORBIDDEN",_.NOT_FOUND="NOT_FOUND",_.CONFLICT="CONFLICT",_.VALIDATION="VALIDATION";const O=(e,s)=>t(void 0,void 0,void 0,(function*(){var t,e;if(!s.response.ok||(null===(t=s.data)||void 0===t?void 0:t.errors)){const t=null===(e=s.data)||void 0===e?void 0:e.errors;throw new R(s.response.status,t)}return s}));var k,A;!function(t){t.EQ="$eq",t.NE="$ne",t.GT="$gt",t.GTE="$gte",t.LT="$lt",t.LTE="$lte",t.IN="$in"}(k||(k={}));class N{constructor(){this.query={}}addRule(t,e,s=""){return this.query.hasOwnProperty(t)||(this.query[t]={}),this.query[t][e]=s,this}removeRule(t,e){return this.query.hasOwnProperty(t)&&this.query[t].hasOwnProperty(e)&&(delete this.query[t][e],0===Object.keys(this.query[t]).length&&delete this.query[t]),this}eq(t,e){return this.addRule(t,k.EQ,e)}ne(t,e){return this.addRule(t,k.NE,e)}gt(t,e){return this.addRule(t,k.GT,e)}gte(t,e){return this.addRule(t,k.GTE,e)}lt(t,e){return this.addRule(t,k.LT,e)}lte(t,e){return this.addRule(t,k.LTE,e)}in(t,e){return this.addRule(t,k.IN,e)}toString(){return"query="+JSON.stringify(this.query)}}!function(t){t[t.ASC=1]="ASC",t[t.DESC=0]="DESC"}(A||(A={}));class U{constructor(){this.sort={}}addRule(t,e=A.ASC){return this.sort[t]=e,this}removeRule(t){return delete this.sort[t],this}asc(t){return this.addRule(t,A.ASC)}desc(t){return this.addRule(t,A.DESC)}toString(){return"sort="+JSON.stringify(this.sort)}}const I="id";var b,F;!function(t){t.EQ="",t.NE="ne",t.GT="gt",t.GE="ge",t.LT="lt",t.LE="le",t.IN="in"}(b||(b={}));class w{__isReserved(t){return this[t]&&r(this[t])}__composeFilterName(t,e=""){return""===e?t:`${t}(${e})`}addFilter(t,e="",s=""){if(t){const r=this.__composeFilterName(t,e);this.__isReserved(r)||(this[r]=s)}return this}removeFilter(t,e=""){if(t){const s=this.__composeFilterName(t,e);this.__isReserved(s)||delete this[s]}return this}eq(t,e){return this.addFilter(t,b.EQ,e)}ne(t,e){return this.addFilter(t,b.NE,e)}gt(t,e){return this.addFilter(t,b.GT,e)}ge(t,e){return this.addFilter(t,b.GE,e)}lt(t,e){return this.addFilter(t,b.LT,e)}le(t,e){return this.addFilter(t,b.LE,e)}in(t,e){return this.addFilter(t,b.IN,e)}}class P{constructor(){this.skip=0}reset(){this.skip=0}load(t){const e=`skip=${this.skip}&limit=${t}`;return this.skip+=t,e}}class D{constructor(t){this.pageSize=t}setPageSize(t){this.pageSize=t}page(t){return`skip=${t>0?t*this.pageSize:0}&limit=${this.pageSize}`}}!function(t){t.ASC="asc",t.DESC="desc"}(F||(F={}));class C{constructor(){this.rules=[]}addRule(t,e=F.ASC){return this.rules.push({name:t,direction:e}),this}asc(t){return this.addRule(t,F.ASC)}desc(t){return this.addRule(t,F.DESC)}toString(){return"sort="+this.rules.map(t=>`${t.name}(${t.direction})`).join(",")}}const j={errors:[{type:_.MALFORMED}]},q=(e,s)=>t(void 0,void 0,void 0,(function*(){let t;const e=yield s.response.text();if(e)try{t=JSON.parse(e)}catch(e){t=j}return Object.assign(Object.assign({},s),{data:t})}));class L{constructor(t){this.key=t}retrieve(){return sessionStorage.getItem(this.key)}store(t){sessionStorage.setItem(this.key,t)}}const $=(t,e="id")=>{const s=[];return t.forEach(t=>{const r=t[e];Array.isArray(r),s.push(r)}),s},M=(t,e="id")=>t.reduce((t,s)=>(t[s[e]]=s,t),{}),H=(t,e)=>e.map(e=>t[e]),x=(t,e)=>{if(e<=0)return[t];let s=0,r=[];for(;s<t.length;)r.push(t.slice(s,s+e)),s+=e;return r};export{E as ApiAuth,R as ApiError,_ as ApiErrorCategory,y as ApiErrorItem,h as ApiExecution,a as ApiFetcher,b as ApiFilterOperator,w as ApiFilters,P as ApiLazyLoading,D as ApiPagination,k as ApiQueryRuleType,C as ApiSort,F as ApiSortDirection,A as ApiSortValue,S as AuthenticationMethod,p as COGNITO_ENDPOINT,f as COGNITO_ID_TOKEN_KEY,v as COGNITO_REFRESH_TOKEN_KEY,m as COGNITO_TOKEN_TIMEOUT,I as ID_PROPERTY,u as LEGACY_SESSION_TOKEN_KEY,d as LegacyApiAuth,i as LegacyApiError,N as LegacyApiQuery,U as LegacyApiSort,L as SessionTokenStore,g as apiErrorItemTypeRegex,n as defaultHeaders,$ as getAllIds,T as injectAuthorizationTokenFactory,l as legacyParseContent,o as legacyThrowError,M as mapById,q as parseContent,H as selectByIds,x as splitIntoChunks,O as throwError};
//# sourceMappingURL=index.esm.min.js.map
